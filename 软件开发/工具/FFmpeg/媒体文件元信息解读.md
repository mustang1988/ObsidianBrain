## 媒体文件元信息解读
### 获取媒体元信息
获取测试用媒体文件: [下载地址](https://4kmedia.org/sony-swordsmith-hdr-uhd-4k-demo/), 下载后重命名媒体文件为: Swordsmith.mp4

使用 [[FFprobe]] 通过以下参数读取媒体文件元信息
```bash
ffprobe -v 0 -of json -show_streams -show_format -i Swordsmith.mp4
```

得到输出的元信息
```json
{
    "streams": [
        {
            "index": 0,
            "codec_name": "hevc",
            "codec_long_name": "H.265 / HEVC (High Efficiency Video Coding)",
            "profile": "Main 10",
            "codec_type": "video",
            "codec_tag_string": "hvc1",
            "codec_tag": "0x31637668",
            "width": 3840,
            "height": 2160,
            "coded_width": 3840,
            "coded_height": 2160,
            "closed_captions": 0,
            "film_grain": 0,
            "has_b_frames": 1,
            "sample_aspect_ratio": "1:1",
            "display_aspect_ratio": "16:9",
            "pix_fmt": "yuv420p10le",
            "level": 153,
            "color_range": "tv",
            "color_space": "bt2020nc",
            "color_transfer": "smpte2084",
            "color_primaries": "bt2020",
            "chroma_location": "topleft",
            "refs": 1,
            "id": "0x1",
            "r_frame_rate": "60000/1001",
            "avg_frame_rate": "60000/1001",
            "time_base": "1/60000",
            "start_pts": 0,
            "start_time": "0.000000",
            "duration_ts": 5165160,
            "duration": "86.086000",
            "bit_rate": "71382367",
            "nb_frames": "5160",
            "extradata_size": 150,
            "disposition": {
                "default": 1,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "creation_time": "2016-10-24T06:29:51.000000Z",
                "language": "und",
                "handler_name": "Video Media Handler",
                "vendor_id": "[0][0][0][0]",
                "encoder": "HEVC Coding"
            }
        },
        {
            "index": 1,
            "codec_name": "aac",
            "codec_long_name": "AAC (Advanced Audio Coding)",
            "profile": "LC",
            "codec_type": "audio",
            "codec_tag_string": "mp4a",
            "codec_tag": "0x6134706d",
            "sample_fmt": "fltp",
            "sample_rate": "48000",
            "channels": 2,
            "channel_layout": "stereo",
            "bits_per_sample": 0,
            "id": "0x2",
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/48000",
            "start_pts": 0,
            "start_time": "0.000000",
            "duration_ts": 4132864,
            "duration": "86.101333",
            "bit_rate": "192000",
            "nb_frames": "4037",
            "extradata_size": 2,
            "disposition": {
                "default": 1,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "creation_time": "2016-10-24T06:29:51.000000Z",
                "language": "eng",
                "handler_name": "Sound Media Handler",
                "vendor_id": "[0][0][0][0]"
            }
        }
    ],
    "format": {
        "filename": "Swordsmith.mp4",
        "nb_streams": 2,
        "nb_programs": 0,
        "format_name": "mov,mp4,m4a,3gp,3g2,mj2",
        "format_long_name": "QuickTime / MOV",
        "start_time": "0.000000",
        "duration": "86.101333",
        "size": "770255991",
        "bit_rate": "71567392",
        "probe_score": 100,
        "tags": {
            "major_brand": "isom",
            "minor_version": "1",
            "compatible_brands": "isom",
            "creation_time": "2016-10-24T05:33:14.000000Z"
        }
    }
}
```

元信息中包含 streams 和 format 两部分信息, 分别对应媒体文件的流信息和格式信息

### 流信息解读
在解析得到的元信息中, 流信息即为 streams 属性下的信息, 其格式为对象数组, 数组长度为媒体包含的流的数量, 数组中每个元素即为对应流的信息

每个流一定包含有以下2个属性

|属性名|属性数据类型|属性说明|
|:-|:-|:-|
|index|Number|当前流在媒体文件所有流中的索引号, 索引号起始值为0|
|codec_type|String|当前流的类型, 常见以下几种值[^流类型]|

#### 视频流信息解读
根据codec_type值, 取出元信息中的视频流部分
```json
{
	"index": 0,
	"codec_name": "hevc",
	"codec_long_name": "H.265 / HEVC (High Efficiency Video Coding)",
	"profile": "Main 10",
	"codec_type": "video",
	"codec_tag_string": "hvc1",
	"codec_tag": "0x31637668",
	"width": 3840,
	"height": 2160,
	"coded_width": 3840,
	"coded_height": 2160,
	"closed_captions": 0,
	"film_grain": 0,
	"has_b_frames": 1,
	"sample_aspect_ratio": "1:1",
	"display_aspect_ratio": "16:9",
	"pix_fmt": "yuv420p10le",
	"level": 153,
	"color_range": "tv",
	"color_space": "bt2020nc",
	"color_transfer": "smpte2084",
	"color_primaries": "bt2020",
	"chroma_location": "topleft",
	"refs": 1,
	"id": "0x1",
	"r_frame_rate": "60000/1001",
	"avg_frame_rate": "60000/1001",
	"time_base": "1/60000",
	"start_pts": 0,
	"start_time": "0.000000",
	"duration_ts": 5165160,
	"duration": "86.086000",
	"bit_rate": "71382367",
	"nb_frames": "5160",
	"extradata_size": 150,
	"disposition": {
		"default": 1,
		"dub": 0,
		"original": 0,
		"comment": 0,
		"lyrics": 0,
		"karaoke": 0,
		"forced": 0,
		"hearing_impaired": 0,
		"visual_impaired": 0,
		"clean_effects": 0,
		"attached_pic": 0,
		"timed_thumbnails": 0,
		"captions": 0,
		"descriptions": 0,
		"metadata": 0,
		"dependent": 0,
		"still_image": 0
	},
	"tags": {
		"creation_time": "2016-10-24T06:29:51.000000Z",
		"language": "und",
		"handler_name": "Video Media Handler",
		"vendor_id": "[0][0][0][0]",
		"encoder": "HEVC Coding"
	}
},
```

|属性名|属性数据类型|属性说明|
|:-|:-|:-|
|codec_name, codec_long_name|String|视频流编码器的简称与全称|
|width, coded_width, height, coded_height|Number|width, height为视频的宽度和高度, 单位: 像素, coded_width, coded_height为视频的编码宽度和编码高度[^编码宽高], 单位: 像素|
|has_b_frames|Number|解码器中帧重排序缓冲区的大小[^帧重排序缓冲区]|
|sample_aspect_ratio, display_aspect_ratio|String|字符串比值, 比值分隔符为":", sample_aspect_ratio为视频流的采样宽高比, display_aspect_ratio为播放时的显示宽高比[^常见宽高比]|
|pix_fmt|String|画面的像素格式|
|color_range, color_space, color_transfer 和 color_primaries|String|这几个属性均用来描述视频色彩范围, TODO about HDR|
|r_frame_rate, avg_frame_rate|String|字符串比值, 比值分隔符为"/", r_frame_rate表示视频的真实帧率, avg_frame_rate为平均帧率|
|duration|Number|视频流时长, 单位: 秒|
|bit_rate|Number|视频流码率, 单位: bps|
|nb_frames|Number|视频流总帧数|

#### 音频流信息解读
根据codec_type值, 取出元信息中的音频流部分

```json
{
	"index": 1,
	"codec_name": "aac",
	"codec_long_name": "AAC (Advanced Audio Coding)",
	"profile": "LC",
	"codec_type": "audio",
	"codec_tag_string": "mp4a",
	"codec_tag": "0x6134706d",
	"sample_fmt": "fltp",
	"sample_rate": "48000",
	"channels": 2,
	"channel_layout": "stereo",
	"bits_per_sample": 0,
	"id": "0x2",
	"r_frame_rate": "0/0",
	"avg_frame_rate": "0/0",
	"time_base": "1/48000",
	"start_pts": 0,
	"start_time": "0.000000",
	"duration_ts": 4132864,
	"duration": "86.101333",
	"bit_rate": "192000",
	"nb_frames": "4037",
	"extradata_size": 2,
	"disposition": {
		"default": 1,
		"dub": 0,
		"original": 0,
		"comment": 0,
		"lyrics": 0,
		"karaoke": 0,
		"forced": 0,
		"hearing_impaired": 0,
		"visual_impaired": 0,
		"clean_effects": 0,
		"attached_pic": 0,
		"timed_thumbnails": 0,
		"captions": 0,
		"descriptions": 0,
		"metadata": 0,
		"dependent": 0,
		"still_image": 0
	},
	"tags": {
		"creation_time": "2016-10-24T06:29:51.000000Z",
		"language": "eng",
		"handler_name": "Sound Media Handler",
		"vendor_id": "[0][0][0][0]"
	}
}
```

|属性名|属性数据类型|属性说明|
|:-|:-|:-|
|codec_name, codec_long_name|String|音频编码器名的简称和全称|
|sample_fmt|String|音频采样格式|
|sample_rate|Number|音频采样率, 单位: Hz|
|channels|Number|音频通道数量, 与音频声道布局有关|
|channel_layout|String|音频声道布局|
|bits_per_sample|Number|每个采样点数据比特数量|
|bit_rate|Number|音频码率, 单位: bps|

### 格式信息解读
取出元信息中的format部分

```json
{
	"filename": "Swordsmith.mp4",
	"nb_streams": 2,
	"nb_programs": 0,
	"format_name": "mov,mp4,m4a,3gp,3g2,mj2",
	"format_long_name": "QuickTime / MOV",
	"start_time": "0.000000",
	"duration": "86.101333",
	"size": "770255991",
	"bit_rate": "71567392",
	"probe_score": 100,
	"tags": {
		"major_brand": "isom",
		"minor_version": "1",
		"compatible_brands": "isom",
		"creation_time": "2016-10-24T05:33:14.000000Z"
	}
}
```

|属性名|属性数据类型|属性说明|
|:-|:-|:-|
|filename|String|文件路径|
|nb_streams|Number|文件中包含的流数量|
|format_name, format_long_name|String|封装格式名称的简称和全称|
|start_time|Number|文件开始时间, 单位: 秒|
|duration|Number|文件封装格式时长, 单位: 秒|
|size|Number|文件大小, 单位: Byte|
|probe_score|Number|FFprobe给出的文件信息价值评分[^FFprobe评分]|

#FFprobe #Metadata 

[^流类型]: 常见流类型有 "video", "audio", "data", "subtitle", 分别表示当前流的类型为, 视频流, 音频流, 数据流和字幕流
[^编码宽高]: 因为某些编码器对视频流的尺寸有倍数要求, 例如: H.264, 当编码时指定的视频宽高不是编码器要求值的倍数时, 编码器在编码时会将宽高填充到最接近目标宽高值的一个倍数值(不会超过指定的宽高值)进行编码, 并为解码器存储裁剪值, coded_width和coded_height值就是裁剪前的宽高值, 一般情况下, 视频文件的 width和coded_width会是相等的, height和coded_height也会是相等的
[^帧重排序缓冲区]: 可以将此属性理解为视频中的双向预测帧(B帧)向前和向后引用了多少帧的数据, 当此属性值为0时, 意味着视频流中并没有B帧, 只有I帧+P帧, 或只有I帧, 关于I,P,B帧, 可参考: https://player.bilibili.com/player.html?aid=37424012&bvid=BV1nt411Q7S6&cid=65779111&page=1
[^常见宽高比]: "4:3", 多用于传统模拟信号的电视节目, "16:9", 多用于数字影视内容
[^FFprobe评分]: 一个输入(在本例中是一个文件)可以有一个扩展名(比如".avi")并且具有不同的格式(例如wav文件), FFmpeg可以检测输入的真实格式(使用ffprobe), 为了做到这一点，它打开文件并读取它(前5秒，如果我没记错的话，由选项analyzeduration设置), 然后，它给每一种格式分配一个分数:如果数据与输入无关，得分较低;如果格式看起来正确，得分较高, 返回的格式是得分最高的格式, Probe_score是这个分数